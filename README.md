
![Simulation Logo](/docs/logo.jpg)


# Simulation
[![Checked with mypy](https://www.mypy-lang.org/static/mypy_badge.svg)](https://mypy-lang.org/)
[![Linting: Ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/charliermarsh/ruff/main/assets/badge/v2.json)](https://github.com/astral-sh/ruff)
[![Roadmap](https://img.shields.io/badge/%F0%9F%97%BA%EF%B8%8F-Roadmap%20-0a0a0a.svg?style=flat&colorA=0a0a0a)](https://zhukovsd.github.io/python-backend-learning-course/projects/simulation/)

Это пошаговая симуляция 2D-мира, населённого травоядными и хищниками. 
В этом мире также есть ресурсы в виде травы, которой питаются травоядные. 
Кроме того, есть статичные объекты, которые не могут взаимодействовать с другими элементами мира (деревья и камни).


Мир представлен в виде матрицы NxM. Каждое существо или объект занимает целую клетку, при этом нахождение нескольких объектов/существ в одной клетке недопустимо.

Каждый ход существа выполняют различные действия.
Все существа:
  - Испытывают голод, который уменьшает их количество здоровья
  - Движутся к своей цели
  - Поедают траву / добычу, если находятся рядом с ней

Хищники:
  - Атакуют свою цель, пока у нее есть здоровье, только после этого могут съесть добычу 
 
Создание существ происходит в начале симуляции и в с заданным интервалом.

Пользователь может останавливать симуляцию, запускать симуляцию в обратном порядке (отмена уже сделанных ходов) и выходить из симуляции

Доступна гибкая настройка параметров симуляции:
  - размеры мира
  - параметры сущностей
  - начальное количество сущностей
  - интервалы создания и количество создаваемых сущностей (доступны те сущности, которые исчезают с карты: хищники, травоядные и трава)
  - количество здоровья, которое уменьшает голод каждый ход
  - иконки изображения сущностей на корте

Вся настройка происходит в config.toml, но если данный файл не создан используются параметры из config.example.toml


![Simulation Demo](/docs/demo.mp4)

## Installation

1. Склонировать репозиторий

```sh
git clone git@github.com:ApostolFet/Simulation.git
cd Simulation
```

2. Создать виртуальное окружение

```sh
python -m venv .venv
```

3. Активировать виртуальное окружение

```sh
. .venv/bin/activate
```

4. Установить пакет

```sh
pip install .
```

5. Скопировать пример конфига в config.toml (опционально, если конфиг не задан, используется config.example.toml)
```sh
cp config.example.toml config.toml
```

6. Откройте кофиг и отредактируйте параметры (опционально)
```sh
nano config.toml
```
7. Запустите симуляцию
```sh
simulation
```

## Technical details

### Patterns

В рамках разработки были применены следующие паттерны:
  - Команда (Command)
  - Стратегия (Strategy)
  - Цепочка обязанностей (Chain of Command)
  - Прототип (Prototype)
  - Фабрика (Factory)
  и другие


#### Command

Данный паттерн использовался при реализации классов: Action (и его подклассов) и Turn (и его подклассов).
Они инкапсулируют в себе действия над картой и действия существ во время хода соответсвенно.
Каждый подкласс реализует одно конкретное действие в рамках своей ответственности.
Данные классы также имеют функцию отмены действия для возможности возвращения по истории команд.

UML Диаграмма классов для Turn

![Simulation UML Turn](/docs/Simulation_UML_Turn.png)

#### Strategy

Для инкапсуляции алгоритма поиска крайтчайщего пути был использован паттерн Стратегия.
Класс команды, который отвечает за движение существ определяет интерфейс для поиска пути, и принимает его через аргументы конструкции.
В рамках данной стратегии были реализованы следующие алгоритмы:
  - Поиск в ширину (breadth-first search) 
  - Поиск A* (A star)

Оба алгоритма находят оптимальных путь до цели, но абстракция позволяет реализовать стратегию, которая будет находить другие варианты, что позволит настроить разные стратегии для разных существ.
На практике использутся более эффективный алогоритм A* для всех существ.

#### Chain of Command

Для выполнения ходов используется Цепочка обязанностей. Каждый класс Turn определяет завершать ли код в данный момент или передавать ход дальше по цепочке.
Классы Turn не содержат ссылку на следующую команду, данную задачу на себя берет класс TurnMap, который устанавливает цепочки для различных существ.
Таким обрзом, существо может выполнять несколько действий заход с гибкой настройкой взаимодействия.

Например: 
Существо может двигаться в сторону цели (класс Move). 
Eсли скорость больше, чем расстояние, которое необходимо пройти, существо может сделать следующий ход (Класс Move вернет то что он не завершает текущий ход существа) - атаковать цель (Attack - для Predator) или съесть (Eat - для Herbivore)

#### Prototype

Прототип используется для хранения историй команд.
После выполнения команды создается ее прототип и сохраняется в массив.
В случае если понадобится отмена совершенных действий из массива достается прототип совешенной команды и у нее вызывается метод undo.

#### Factory

Фабрики использутся для создания объектов сущностей, подкласс Action - Spawn - принимает в себя количество существ и фабрику для их создания.
Реализуются конкретные фабрики для создания сущностей, которые конфигурируются настройками и передаются в класс Spawn.


### Project structure

В проекте используется src-layout и приложение устанавливается в виртуальное окружение как пакет.
Добавлены опциональные зависимости для запуска mypy и ruff: **dev**

Вся конфигурация инструментов и пакета определена в файле pyproject.toml

Для преобразования структуры конфига в датакалассы используется библиотека [adaptix](https://adaptix.readthedocs.io/en/latest/) (единственная зависимость в проекте)

Для удобного запуска симуляции была определена точка входа:

```sh
simulation
```
